                                                                                                                                                                                                                                  
# RRRRRRRRRRRRRRRRR   EEEEEEEEEEEEEEEEEEEEEE               AAA                  CCCCCCCCCCCCCHHHHHHHHH     HHHHHHHHH                    AAA                 SSSSSSSSSSSSSSS    SSSSSSSSSSSSSSS IIIIIIIIII   SSSSSSSSSSSSSSS TTTTTTTTTTTTTTTTTTTTTTT
# R::::::::::::::::R  E::::::::::::::::::::E              A:::A              CCC::::::::::::CH:::::::H     H:::::::H                   A:::A              SS:::::::::::::::S SS:::::::::::::::SI::::::::I SS:::::::::::::::ST:::::::::::::::::::::T
# R::::::RRRRRR:::::R E::::::::::::::::::::E             A:::::A           CC:::::::::::::::CH:::::::H     H:::::::H                  A:::::A            S:::::SSSSSS::::::SS:::::SSSSSS::::::SI::::::::IS:::::SSSSSS::::::ST:::::::::::::::::::::T
# RR:::::R     R:::::REE::::::EEEEEEEEE::::E            A:::::::A         C:::::CCCCCCCC::::CHH::::::H     H::::::HH                 A:::::::A           S:::::S     SSSSSSSS:::::S     SSSSSSSII::::::IIS:::::S     SSSSSSST:::::TT:::::::TT:::::T
#   R::::R     R:::::R  E:::::E       EEEEEE           A:::::::::A       C:::::C       CCCCCC  H:::::H     H:::::H                  A:::::::::A          S:::::S            S:::::S              I::::I  S:::::S            TTTTTT  T:::::T  TTTTTT
#   R::::R     R:::::R  E:::::E                       A:::::A:::::A     C:::::C                H:::::H     H:::::H                 A:::::A:::::A         S:::::S            S:::::S              I::::I  S:::::S                    T:::::T        
#   R::::RRRRRR:::::R   E::::::EEEEEEEEEE            A:::::A A:::::A    C:::::C                H::::::HHHHH::::::H                A:::::A A:::::A         S::::SSSS          S::::SSSS           I::::I   S::::SSSS                 T:::::T        
#   R:::::::::::::RR    E:::::::::::::::E           A:::::A   A:::::A   C:::::C                H:::::::::::::::::H               A:::::A   A:::::A         SS::::::SSSSS      SS::::::SSSSS      I::::I    SS::::::SSSSS            T:::::T        
#   R::::RRRRRR:::::R   E:::::::::::::::E          A:::::A     A:::::A  C:::::C                H:::::::::::::::::H              A:::::A     A:::::A          SSS::::::::SS      SSS::::::::SS    I::::I      SSS::::::::SS          T:::::T        
#   R::::R     R:::::R  E::::::EEEEEEEEEE         A:::::AAAAAAAAA:::::A C:::::C                H::::::HHHHH::::::H             A:::::AAAAAAAAA:::::A            SSSSSS::::S        SSSSSS::::S   I::::I         SSSSSS::::S         T:::::T        
#   R::::R     R:::::R  E:::::E                  A:::::::::::::::::::::AC:::::C                H:::::H     H:::::H            A:::::::::::::::::::::A                S:::::S            S:::::S  I::::I              S:::::S        T:::::T        
#   R::::R     R:::::R  E:::::E       EEEEEE    A:::::AAAAAAAAAAAAA:::::AC:::::C       CCCCCC  H:::::H     H:::::H           A:::::AAAAAAAAAAAAA:::::A               S:::::S            S:::::S  I::::I              S:::::S        T:::::T        
# RR:::::R     R:::::REE::::::EEEEEEEE:::::E   A:::::A             A:::::AC:::::CCCCCCCC::::CHH::::::H     H::::::HH        A:::::A             A:::::A  SSSSSSS     S:::::SSSSSSSS     S:::::SII::::::IISSSSSSS     S:::::S      TT:::::::TT      
# R::::::R     R:::::RE::::::::::::::::::::E  A:::::A               A:::::ACC:::::::::::::::CH:::::::H     H:::::::H       A:::::A               A:::::A S::::::SSSSSS:::::SS::::::SSSSSS:::::SI::::::::IS::::::SSSSSS:::::S      T:::::::::T      
# R::::::R     R:::::RE::::::::::::::::::::E A:::::A                 A:::::A CCC::::::::::::CH:::::::H     H:::::::H      A:::::A                 A:::::AS:::::::::::::::SS S:::::::::::::::SS I::::::::IS:::::::::::::::SS       T:::::::::T      
# RRRRRRRR     RRRRRRREEEEEEEEEEEEEEEEEEEEEEAAAAAAA                   AAAAAAA   CCCCCCCCCCCCCHHHHHHHHH     HHHHHHHHH     AAAAAAA                   AAAAAAASSSSSSSSSSSSSSS    SSSSSSSSSSSSSSS   IIIIIIIIII SSSSSSSSSSSSSSS         TTTTTTTTTTT                                                   
#                                    ::::::                                                           
#                                ::--:--:-=--=-                                                       
#                               ::-*+---=-=+++=-                                                      
#                              :::-===+*++**++*+                                                      
#                              :-----++++=*++*+==                                                     
#                              :-=***-=*+++*+*#**+                                                    
#                              .+*+*==++--**=*****+     ::----------:                                 
#                               =--+===-==+++++===-:--:------=====--=--                               
#                                -*++---==+**++====---:-======++++==------=--------:                  
#                                 =##+++-=-=+*+==----::--====--=++----++****+++++++===                
#                                 =+=+==++****+==---::::::::::-+=-----=#######*******+++-             
#                                :**=**===###**==---:::::::::--------+*%%%##*+=-====++***+            
#                               :::-=#*%++**##*+=---::::::---=+===+=*#%%%+=+**=-=+#*====-             
#                              .::-=*+*##+***#**=-:-::::----*##-*+*+*##+*##*=--=*#+*====-             
#                             :::-+*%%**#***#**+--:-::::---=+**-*+***###***+=+**+*%+-=-==             
#                            :--=++#*-+*+=+**+=---:-:::-===+==**######********##%%#=-=-==-            
#                            :-==**:---=++*+===--::-:--=+++=---==+++++**##%@*+#+**+=-=--=-            
#                           .::-=+=--==++*+=--------==++=-------=+++++#*==+*=+=-=*=--=--=-            
#                           .:::-==--+++++=-------===::::------=+++****=--=+-----+--=+----            
#                           .:::-=+--+*++=-----==::::::---===---==++*+----==-----==-+**##+            
#                           .:::-=====++%+---=+=-:::-----==---===+++*=**=--=:----=+=#####             
#                           ::::--=++===+%*+++-:--------=++===-:---=+*#:=+=+:-----**+###-             
#                           ::::---=+===+#@%*-------=-::------:---===*=:--+=--=---=*+***              
#                           ::::--==++=+*#%##=::::---::---=+=--=---=--=+#*:-------=+#**+              
#                            :::--==++=-=-:-----------------=*#*=++=-=*+-=*=#+*+--=***++              
#                            :---==-------=------====----=---==*#*=**++*===:=--=#%#**++=              
#               ::::--=---:::::--::----------=--===========--+==+**+**+*:-::=:--+*+=*++               
#              ::-:---=--------::---=--===-=++==============-++==++***#+-::-+:---+-+**=               
#              ::--:---=--+-----::----==-=++==-==-+===========+==++++*%--::=+:--*%***+                
#              :-----::-=---+=:--:------=--==+*=---=====+==+=-----------=++++-+#-+***+                
#             .:----:=:-:----==--::-----=======---:========++++==+##**=--===++=--=**=                 
#             .:----:--:==-=++==-:::::---====++::-:-=======++======+**%%%###*+*###*+                  
#             ::---:::=--==+=+*=-:::----=====+---:--+*+====++=======++#*+++=+++===*=                  
#             ::==-:::-=--===+*=-:::----=====+*##*=*+++*###*+========++*##*+++==+**+                  
#             :-==-::::-=-:-=----:::----===+=*-:--:-=*+===##%%###*+=====++*#%####***                  
#             :-==-:::::==::-----:::----==+++-+-:--#*++++=********##%%##*+=++=++***+                  
#            .:-==--::::-==--++=-::---===+++==++-=##====+=*++++++++++++***##%**#%%#*                  
#            ::-==--:::::--:--==-::---===++==+==-++*-=====*++++++======++++++==++++-                  
#            ::====-::::-:=--=+=:::--==++++=+==-==*=:=====*+++++++=======+======+++=                  
#            +#*===-:::::-:==--=::---==++==+===--=*-:=====*++++++========+====-+++++                  
#            :-##==--:::::-:==--::--===+-++===-::*+--+=+=+*++++++++=============++++                  
#            :+###*-::::::-::==-::---===+++=---:=#-:-+=+=+*+++++++=============-++++:                 
#            :*#*++#%*-:::::--=:::-===++===---:=#---=+===+*+++++++==++=========-=+++=                 
#              ++--+##%%%*-::------++===-----+%%+-::=====**+++++==++=============+=++:                
#               -::+**#*#%%#*=---==----=*#%%%#%%=---=+===*+++++==+++==============+++=                
#               :::=*+*+###*##-:-==+***#%%%%####--:-+===**++++++++=++=============++++                
#               :::=++=*+=-------===+*#%%%%####+::-====+**+++++==++===============++++=               
#                ::===--=----=+-=--=+*%%%%%####-::=====**+++++=====================++++-              
#         .-:   -==+=-=------=====+++*%%%%####+::-====**++++++=================+====+++=              
#       :+::=+*----=-+-=====-=+=++++++####%##+::-====+**+++++========================+++=             
#       =*=++=:---=--====----=+++++=+++++==++---=====**++++=======================+++++++=            
#       =:--=-=******#=--::::-=+========++=====+========+++=========================++++++            
#        ---++===*##*=-:::::-++======================================================++++++           
#       :--*###+-++=--------=**+==++==+===++==========================================++++++-         
#     - :=+*+----------:-==**####*****++++*+++++=+===+===========================++++++======-        
#  := +:-=---::-:-----=++*+===+********######***+++++++++++++++++++=====================+++++++++-    
#  -+--------:-----=+*+===-::-+===++++++************###****+++++++++++++++++=================++++=    
# -=-----::----=++*+==--::----+=======+=+++++++++++++**********#####**+++++++++++==+++++++=++=++++    
# :--::-----==+*+==--:--:::::-++========+++++++++++++++++++++++++*********######**++***+++++++++*+=++ 
# --:----+=**+==-----::::::::-++=+========+++++++++++==++++++++++++++++++++++*********####***+++**++++                                                                                                                                                                                                           
                                                                                                                                                                                                                                                 
            
from langchain_google_genai import ChatGoogleGenerativeAI
from langchain_openai import ChatOpenAI
from pydantic import BaseModel, Field
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.runnables import RunnableLambda
from typing_extensions import TypedDict
from langgraph.graph import StateGraph, START, END
import time
import traceback


import os
import dotenv
dotenv.load_dotenv()


# ███████╗████████╗ █████╗ ████████╗███████╗
# ██╔════╝╚══██╔══╝██╔══██╗╚══██╔══╝██╔════╝
# ███████╗   ██║   ███████║   ██║   █████╗  
# ╚════██║   ██║   ██╔══██║   ██║   ██╔══╝  
# ███████║   ██║   ██║  ██║   ██║   ███████╗
# ╚══════╝   ╚═╝   ╚═╝  ╚═╝   ╚═╝   ╚══════╝

class State_reach_assistant(TypedDict):
    tema_de_investigacion: str
    caracteristicas_clave: str
    abstract: str
    relevancia: str
    razones: str



# ███████╗████████╗██████╗ ██╗   ██╗ ██████╗████████╗██╗   ██╗██████╗ ███████╗██████╗ 
# ██╔════╝╚══██╔══╝██╔══██╗██║   ██║██╔════╝╚══██╔══╝██║   ██║██╔══██╗██╔════╝██╔══██╗
# ███████╗   ██║   ██████╔╝██║   ██║██║        ██║   ██║   ██║██████╔╝█████╗  ██║  ██║
# ╚════██║   ██║   ██╔══██╗██║   ██║██║        ██║   ██║   ██║██╔══██╗██╔══╝  ██║  ██║
# ███████║   ██║   ██║  ██║╚██████╔╝╚██████╗   ██║   ╚██████╔╝██║  ██║███████╗██████╔╝
# ╚══════╝   ╚═╝   ╚═╝  ╚═╝ ╚═════╝  ╚═════╝   ╚═╝    ╚═════╝ ╚═╝  ╚═╝╚══════╝╚═════╝ 

class Relevancia(BaseModel):
    """"""
    relevancia: str = Field(description='''Expresa cual es el nivel de relevancia determinado el artículo analizado. Solamente puede tomar los valores de: "alta", "media", "baja" o "no relevante"''')
    razones: str = Field(description="Expresa el motivo por el cual se ha asignado ese valor de relevancia. Debe de ser resumido y consiso.")



class Asisten_Investigacion:
    def __init__(self,selected_model:int, model_temperature: float, max_tokens:int):
        self.selected_model = selected_model
        self.model_temperature = model_temperature
        self.max_tokens = max_tokens
        self.project_code = "asisten_investigacion_v2"
        self.model_inicialization()
        self.chains_inicialization()
        self.graphs_inicialization()


# ███╗   ███╗ ██████╗ ██████╗ ███████╗██╗      ██████╗ ███████╗
# ████╗ ████║██╔═══██╗██╔══██╗██╔════╝██║     ██╔═══██╗██╔════╝
# ██╔████╔██║██║   ██║██║  ██║█████╗  ██║     ██║   ██║███████╗
# ██║╚██╔╝██║██║   ██║██║  ██║██╔══╝  ██║     ██║   ██║╚════██║
# ██║ ╚═╝ ██║╚██████╔╝██████╔╝███████╗███████╗╚██████╔╝███████║
# ╚═╝     ╚═╝ ╚═════╝ ╚═════╝ ╚══════╝╚══════╝ ╚═════╝ ╚══════╝

    def model_inicialization(self):
        try:
            print("MODELOS\t..................................",end='')
            if self.selected_model == 0:
                model_name = "gpt-4o-mini"
                self.model = ChatOpenAI(
                    api_key=os.getenv("OPENAI_API_KEY"),
                    model=model_name,
                    temperature=self.model_temperature,
                    max_tokens=self.max_tokens
                )
            elif self.selected_model == 1:
                model_name = "gemini-2.0-flash-lite"
                self.model = ChatGoogleGenerativeAI(
                    api_key=os.getenv("GEMINI_API_KEY"),
                    model=model_name,
                    temperature=self.model_temperature,
                    max_tokens=self.max_tokens,
                )
            self.model_name = model_name
            self.project_code += '-' + model_name
            print("INICIADO")
        except Exception as e:
            print("FALLIDO")
            print(e)

#  ██████╗ █████╗ ██████╗ ███████╗███╗   ██╗ █████╗ ███████╗
# ██╔════╝██╔══██╗██╔══██╗██╔════╝████╗  ██║██╔══██╗██╔════╝
# ██║     ███████║██║  ██║█████╗  ██╔██╗ ██║███████║███████╗
# ██║     ██╔══██║██║  ██║██╔══╝  ██║╚██╗██║██╔══██║╚════██║
# ╚██████╗██║  ██║██████╔╝███████╗██║ ╚████║██║  ██║███████║
#  ╚═════╝╚═╝  ╚═╝╚═════╝ ╚══════╝╚═╝  ╚═══╝╚═╝  ╚═╝╚══════╝

    def chains_inicialization(self):
        try:
            print("CADENAS\t..................................",end='')
            # Prompt Template
            prompt_evalua_relevancia = """Como asistente de inteligencia artificial, tu tarea es ayudar a los investigadores a determinar la relevancia de un artículo de investigación en relación con su tema de interés. Para cada artículo que se va a revisar, se te proporcionará el tema específico de investigación del investigador y el resumen (abstract) del artículo en cuestión. Tu objetivo es analizar ambos textos y evaluar la relevancia del artículo para el investigador teniendo en cuenta ciertas características clave.

Por favor, sigue los siguientes pasos para realizar tu evaluación:

1. **Comprensión del Tema de Investigación:** Lee y comprende el tema de investigación proporcionado por el investigador. Identifica las palabras clave y los conceptos centrales.

2. **Análisis del Abstract:** Lee el abstract del artículo de investigación. Identifica las palabras clave, los objetivos del estudio, la metodología empleada y los resultados principales.

3. **Evaluación de las Características Clave:** Lee y emplea las características clave de relevancia que el autor ha señalado que un artículo relevante debe de cumplir.

4. **Conclusión sobre la Relevancia:** Basado en tu análisis, proporciona una conclusión clara sobre la relevancia del artículo. Usa una escala de "alta", "media", "baja" o "no relevante", y explica brevemente las razones de tu evaluación.

Recuerda tener en cuenta cualquier sinergia potencial entre el tema de investigación y el artículo, así como posibles aplicaciones prácticas o teóricas que puedan ser de interés para el investigador.
"""

            human_prompt_evalua_relevancia = """1. **Tema de Investigación:**
{tema_de_investigacion}

2. **Abstract:**
{abstract}

3. **Características Clave:**
{caracteristicas_clave}
    """

            template_evalua_relevancia = ChatPromptTemplate.from_messages([
                ("system", prompt_evalua_relevancia),
                ("human", human_prompt_evalua_relevancia)
                ])

            # Chain
            self.chain_evalua_relevancia = template_evalua_relevancia | self.model.with_structured_output(Relevancia)
            print("INICIADO")
        except Exception as e:
            print("FALLIDO")
            print(e)
            traceback.print_exc() 




#  ██████╗ ██████╗  █████╗ ███████╗ ██████╗ ███████╗
# ██╔════╝ ██╔══██╗██╔══██╗██╔════╝██╔═══██╗██╔════╝
# ██║  ███╗██████╔╝███████║█████╗  ██║   ██║███████╗
# ██║   ██║██╔══██╗██╔══██║██╔══╝  ██║   ██║╚════██║
# ╚██████╔╝██║  ██║██║  ██║██║     ╚██████╔╝███████║
#  ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝╚═╝      ╚═════╝ ╚══════╝


    def graphs_inicialization(self):
        try:
            print("GRAFOS\t..................................",end='')
            # Builder
            builder = StateGraph(State_reach_assistant)

            # Nodos
            def califica(state):
                # Prepare to exec
                dict_input = {
                    'tema_de_investigacion':state['tema_de_investigacion'],
                    'abstract':state['abstract'],
                    'caracteristicas_clave':state['caracteristicas_clave'],
                }

                # Chain execution
                response = self.chain_evalua_relevancia.invoke(dict_input)
                    
                return {
                    'relevancia':response.relevancia,
                    'razones':response.razones,
                }
            
            builder.add_node("califica", califica)

            # Edges
            builder.add_edge(START, "califica")
            builder.add_edge("califica", END)

            self.graph_reach_assistant = builder.compile()

            print("INICIADO")
        except Exception as e:
            print("FALLIDO")
            print(e)


# ███╗   ███╗███████╗████████╗ ██████╗ ██████╗  ██████╗ ███████╗
# ████╗ ████║██╔════╝╚══██╔══╝██╔═══██╗██╔══██╗██╔═══██╗██╔════╝
# ██╔████╔██║█████╗     ██║   ██║   ██║██║  ██║██║   ██║███████╗
# ██║╚██╔╝██║██╔══╝     ██║   ██║   ██║██║  ██║██║   ██║╚════██║
# ██║ ╚═╝ ██║███████╗   ██║   ╚██████╔╝██████╔╝╚██████╔╝███████║
# ╚═╝     ╚═╝╚══════╝   ╚═╝    ╚═════╝ ╚═════╝  ╚═════╝ ╚══════╝

    def invoke(self, dict_input):
        response = self.graph_reach_assistant.invoke(dict_input)
        return response

    def map_invoke(self, list_dict_input):
        response = self.graph_reach_assistant.map().invoke(list_dict_input)
        return response